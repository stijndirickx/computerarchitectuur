<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Baudtool</title>
</head>
<body>
    <label for="baud">Baudrate</label>
    <input type="text" id="baud">
    <button onclick="calcFbaud()">Calculate</button>
    <p>BSEL: <span id="bsel" style="font-weight: bold;"></span></p>
    <p>BSCALE: <span id="bscale" style="font-weight: bold;"></span></p>
    <p>AFWIJKING: <span id="afwijking" style="font-weight: bold;"></span></p>
    <script>
        fper = 32000000;

        function calcFbaud(){
            fbaud = document.getElementById('baud').value;
            bscale = 0;
            fber = 0; //berekende fbaud

            for (var i = 0; i < 8; i++) {
                bselnew = (fper / (2^i)*16*fbaud) - 1;
                fnew = fper/((2^i)*(16*(bselnew+1)));
                console.log(i)
                console.log("fbaud: " + fnew);
                console.log("bsel: " + bselnew);
                if(Math.abs(fber-fbaud)>Math.abs(fnew-fbaud)){
                    console.log("better on " + i);
                    fber = fnew;
                    bscale = i;
                    bsel = bselnew;
                }
            }
            for (var i = -1; i > -8; i--) {
                bselnew = (1/(2^i))*((fper / (16*fbaud))-1);
                fnew = fper/(16*((bselnew*2^i)+1));
                console.log(i);
                console.log("fbaud: " + fnew);
                console.log("bsel: " + bselnew);
                if(Math.abs(fber-fbaud)>Math.abs(fnew-fbaud)){
                    console.log("better on " + i);
                    fber = fnew;
                    bscale = i;
                    bsel = bselnew;
                }
            }

            document.getElementById("bsel").innerHTML = bsel;
            document.getElementById("bscale").innerHTML = bscale;
            document.getElementById("afwijking").innerHTML = fbaud - fber;
        }
    </script>
</body>
</html>